# P1 - Diff 功能实现计划

功能设计参见 viz-design.md 

UI示意图参见 ui.jpg

## 概述

为 LLM Trace Viewer 添加 Message Diff 功能，显示当前请求与父请求之间消息的差异。

## Diff 逻辑

**比较对象：**
- 父请求：`parent.request_messages` + `parent.response_message`
- 当前请求：`current.request_messages`

**Diff 类型：**
- `unchanged`：相同 ID 存在于两边
- `added`：仅在当前请求中存在（绿色 +）
- `deleted`：仅在父请求中存在（红色 -）
- `modified`：同位置但 ID 不同（显示为 [旧] → [新]）

## 文件变更

### 新建文件（7个）

| 文件 | 说明 |
|------|------|
| `src/utils/diff.ts` | LCS diff 算法 |
| `src/hooks/useDiff.ts` | 计算 diff 的 React hook |
| `src/components/diff/DiffView.tsx` | Diff 视图容器 |
| `src/components/diff/AddedMessage.tsx` | 新增消息（绿色边框） |
| `src/components/diff/DeletedMessage.tsx` | 删除消息（红色边框） |
| `src/components/diff/ModifiedMessage.tsx` | 修改消息（[旧] → [新] 对比） |
| `src/components/diff/UnchangedGroup.tsx` | 折叠的未变化消息组 |

### 修改文件（3个）

| 文件 | 变更 |
|------|------|
| `src/types/index.ts` | 添加 `DiffItem`、`DiffResult` 类型 |
| `src/App.tsx` | 传递 `getRequest` prop 给 RequestDetail |
| `src/components/detail/RequestDetail.tsx` | 集成 DiffView 替换平铺消息列表 |

## 实现步骤

### Step 1: 类型定义

在 `src/types/index.ts` 添加：

```typescript
export interface DiffItem {
  type: 'unchanged' | 'added' | 'deleted' | 'modified';
  oldMessage?: Message;  // unchanged/deleted/modified
  newMessage?: Message;  // unchanged/added/modified
}

export interface DiffResult {
  items: DiffItem[];
  summary: { unchanged: number; added: number; deleted: number; modified: number };
}
```

### Step 2: Diff 算法 (`src/utils/diff.ts`)

使用 LCS（最长公共子序列）算法计算最小编辑距离：

```typescript
export function computeMessageDiff(
  parentMessageIds: string[],
  currentMessageIds: string[],
  getMessage: (id: string) => Message | undefined
): DiffResult
```

- 基于 message ID 比较（cook 已去重）
- 时间复杂度 O(n*m)
- **Modified 检测**：LCS 回溯时，如果连续出现 delete + add（同一位置），合并为 modified

### Step 3: useDiff Hook (`src/hooks/useDiff.ts`)

```typescript
export function useDiff({ currentRequest, parentRequest, getMessage }): {
  diff: DiffResult | null;
  hasParent: boolean;
}
```

- 处理首个请求（无 parent）：所有消息标记为 `added`
- 使用 `useMemo` 缓存计算结果

### Step 4: Diff 组件

**DiffView.tsx**
- 将连续的 unchanged 项分组
- 管理 `expandedGroups` 状态
- 渲染 AddedMessage / DeletedMessage / UnchangedGroup

**AddedMessage.tsx**
- 绿色左边框 + "+" 图标
- 复用 MessageCard

**DeletedMessage.tsx**
- 红色左边框 + "-" 图标
- 透明度降低
- 复用 MessageCard

**ModifiedMessage.tsx**
- 左右并排或上下排列显示 [旧消息] → [新消息]
- 箭头连接两个 MessageCard
- 黄色/橙色边框表示修改

**UnchangedGroup.tsx**
- ≤2 条：直接显示（灰色）
- ≥3 条：折叠为 "... N unchanged messages"
- 点击展开/收起

### Step 5: 集成

**App.tsx** (line 71-75):
```typescript
<RequestDetail
  request={selectedRequest}
  getMessage={getMessage}
  getTool={getTool}
  getRequest={getRequest}  // 新增
/>
```

**RequestDetail.tsx**:
- 添加 `getRequest` prop
- 使用 `useDiff` hook
- Messages tab 中用 `DiffView` 替换原有的 `requestMessages.map()`

## 边界情况

| 情况 | 处理 |
|------|------|
| 首个请求（无 parent） | 所有消息显示为 "added" |
| 无变化 | 显示折叠的 "N unchanged messages" |
| getMessage 返回 undefined | 跳过该消息 |

## 验证方法

1. 运行 viewer: `cd viewer && npm run dev`
2. 选择第一个请求 → 所有消息显示绿色 "+"
3. 选择后续请求 → 显示 diff：
   - 新消息：绿色 "+"
   - 父响应：红色 "-"
   - 修改消息：[旧] → [新] 并排显示
4. 点击 "..." → 展开折叠的未变化消息
5. 切换 Messages/Tools tab → 状态保持
6. 切换不同请求 → diff 重新计算
