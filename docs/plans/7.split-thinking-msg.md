# Plan: Split Thinking and Regular Messages

## Overview

将 Claude 数据预处理中的 Thinking 块从普通消息中拆分出来，作为独立的消息存储和显示。

**当前行为**: Thinking 内容以 `thinking:\n{内容}\n\n{响应}` 格式合并到 assistant 消息中
**目标行为**: Thinking 成为独立消息，角色为 `"thinking"`

## Changes

### 1. Backend: `llm_trace/cook.py`

#### 1.1 Data Structure Change (line 34-44)

```python
# Before
response_message: str  # Message ID

# After
response_messages: list[str]  # Message IDs
```

#### 1.2 `_process_claude_response()` (line 649-695)

- Change return type: `str` → `list[str]`
- Create separate `"thinking"` message for thinking blocks
- Append `"assistant"` message for text/tool_calls

#### 1.3 `_process_claude_content_blocks()` (line 564-647)

- Remove `pending_thinking` buffer logic
- Create separate `"thinking"` message for each thinking block

#### 1.4 `_process_response_message()` (line 480-502)

- Change return type: `str` → `list[str]` (for consistency)

#### 1.5 Update Callers

- `_process_record_claude()` (line 713-746): use `response_messages`
- `_process_record()` (line 748-791): use `response_messages`
- `_build_expected_prefix()` (line 863-872): spread `response_messages` array

### 2. Frontend: TypeScript Types

**File**: `viewer/src/types/index.ts`

```typescript
// line 8: Add "thinking" role
role: 'system' | 'user' | 'tool_use' | 'tool_result' | 'assistant' | 'thinking';

// line 25: Change to array
response_messages: string[];
```

### 3. Frontend: MessageCard Role Config

**File**: `viewer/src/components/detail/MessageCard.tsx` (line 28-59)

Add thinking role:
```typescript
thinking: {
  label: 'thinking',
  colorClass: 'text-role-thinking',
  bgClass: 'bg-role-thinking/10 border-role-thinking/30',
  bgSolidClass: 'bg-[color-mix(in_srgb,var(--color-role-thinking)_10%,var(--color-bg-primary))]',
},
```

### 4. Frontend: CSS Colors

**File**: `viewer/src/index.css`

```css
/* Dark theme (line 23) */
--color-role-thinking: #f0883e;

/* Light theme (line 55) */
--color-role-thinking: #d46a1f;
```

### 5. Frontend: RequestDetail

**File**: `viewer/src/components/detail/RequestDetail.tsx`

- Line 34: Change to array access
- Line 127-136: Render multiple response messages

### 6. Frontend: useDiff Hook

**File**: `viewer/src/hooks/useDiff.ts` (line 32-35)

```typescript
// Before
parentRequest.response_message,

// After
...parentRequest.response_messages,
```

## File Summary

| File | Change |
|------|--------|
| `llm_trace/cook.py` | Data structure + 6 functions |
| `viewer/src/types/index.ts` | Add role, change field |
| `viewer/src/components/detail/MessageCard.tsx` | Add role config |
| `viewer/src/index.css` | Add color variables |
| `viewer/src/components/detail/RequestDetail.tsx` | Handle array |
| `viewer/src/hooks/useDiff.ts` | Spread array |

## Verification

1. Run cook on existing trace:
   ```bash
   uv run llm-trace cook ./traces/cc-raw.json -o ./viewer/public/data.json
   ```

2. Verify output structure:
   ```bash
   jq '.requests[0].response_messages' ./viewer/public/data.json
   jq '.messages[] | select(.role == "thinking")' ./viewer/public/data.json
   ```

3. Start viewer and verify display:
   ```bash
   cd viewer && npm run dev
   ```

4. Check that thinking messages display with orange color and correct label
