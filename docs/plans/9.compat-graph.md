# Goal Description
Optimize the request graph layout in [viewer/src/components/sidebar/RequestGraph.tsx](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx) to fully utilize space. Currently, every new branch is strictly assigned a new column, wasting horizontal space particularly for chronologically disjoint branches. The optimization should use a greedy approach to reuse columns when possible, "shifting new branches to the left if they don't encounter obstacles".

# Proposed Changes

### [viewer/src/components/sidebar/RequestGraph.tsx](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx)

#### 1. Add `branchId` tracking to [buildFlatNodes](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#74-110)
- Extend the [FlatNode](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#14-22) interface with a `branchId: number` property.
- Update [assignCols](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#40-73) (rename to `assignBranchIds`) to assign a unique `branchId` instead of a final column.
- Update the iterations over `singleNodeRoots` and `multiNodeRoots` to pass a `branchId` counter object instead of allocating columns manually.

#### 2. Implement Greedy Column Allocation
- Group all [FlatNode](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#14-22) objects by `branchId` into distinct "branches" after they are sorted by timestamp.
- For each branch, compute its row-span:
  - `startRow`: If the branch has a parent (its root node is `isNewBranch`), start from `parentRow`. Otherwise `min(rowIdx)`.
  - `endRow`: `max(rowIdx)`.
- Sort branches so longest spanning branches get earlier preference to occupy lower index columns.
- Iterate over branches to greedily map their `branchId` to the minimum free `column` where `[startRow, endRow]` does not overlap with previously assigned branches in that column.
- Update the `column` property of each [FlatNode](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#14-22) to its assigned column.

#### 3. Update Line Rendering ([buildLaneSpans](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#130-159) and [ConnectorLayer](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#169-235))
- Currently, [buildLaneSpans](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#130-159) computes a single `openY` and `endY` per column, assuming each column has only one contiguous segment. With the greedy optimization, multiple disconnected branches can share the same column.
- Refactor [buildLaneSpans](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#130-159) to compute bounding [LaneSpan](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#113-117) per `branchId` instead of per `column`.
  - `Map<number, LaneSpan>` where the key is `branchId`.
- In [ConnectorLayer](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#169-235), iterate over `branchSpans` to draw the vertical lines using the `branchId`, translating it to [colX(flatNodes_in_branch[0].column)](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#122-125).

# Verification Plan

### Automated Tests
Currently there are no unit tests covering the React render logic, so verification will primarily be manual.

### Manual Verification
1. Re-build or run the frontend viewer and open the graph layout visualization.
2. Produce test cases with parallel, interleaved requests and ensure:
    - Independent tree branch nodes appropriately shift left into available gaps
    - No disconnected parts within a single column are erroneously connected by vertical line segments
    - S-curves render correctly exactly reaching from the true `parent` column to the `child` column.
    - Isolated nodes render precisely without connecting lines overlaying them.


# Graph Layout Optimization Walkthrough

The Request Graph has been optimized to fully utilize available rendering space by aggressively shifting independent branches to the left side into empty rendering slots, instead of permanently dedicating an entire column width for the complete graph height.

## Changes Made

1. **Upgraded Node Data Model** 
   - [FlatNode](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#14-23) interface now tracks `branchId`, uniquely identifying a chronologically connected sequence of nodes.
   - Restructured branching logic ([assignBranchIds](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#41-75)) to track the logical `branchId` rather than locking a component directly to a visual `column`.

2. **Greedy Layout Algorithm**
   - Each branch aggregates its row bounds, identifying its `[startRow, endRow]` span.
   - A deterministic scan assigns branches to the free, left-most column (beginning from `col: 1` or `col: 0` if available) that does not overlap with any pre-existing branch vertically.
   - Resulting coordinates perfectly fold overlapping isolated lines seamlessly.

3. **Rendering Adaptations Component ([ConnectorLayer](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#220-286))**
   - Reworked [LaneSpans](file:///Users/bytedance/github/llm-trace/viewer/src/components/sidebar/RequestGraph.tsx#181-210) tracking to register spans *per branch*, preventing independent branches erroneously linking together purely because they share a column graphically.

## Verification
- Code successfully passes React TS compilation (`npm run build`).
- Ensure no overlaps when rendering the page.

### Manual Testing Needed
Please load up `llm-trace` using your standard workflow and verify the tree rendering works perfectly on complex multi-turn branching conversations. Branches with completed histories should seamlessly wrap.
